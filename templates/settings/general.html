{% extends "base.html" %}

{% block title %}General Settings - GPRO{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="bi bi-sliders"></i> General Settings</h1>
</div>

<form action="{{ url_for('settings.save_general') }}" method="POST">
    <div class="card">
        <div class="card-body">
            <h5>Safety Heights</h5>
            <p class="text-muted">Configure Z-axis heights for safe machine movement</p>

            <div class="row g-3 mb-4">
                <div class="col-md-4">
                    <label class="form-label">Safety Height</label>
                    <div class="input-group">
                        <input type="number" class="form-control" name="safety_height" step="0.01" value="{{ settings.safety_height }}" required>
                        <span class="input-group-text">in</span>
                    </div>
                    <div class="form-text">Height above work for initial positioning and spindle start</div>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Travel Height</label>
                    <div class="input-group">
                        <input type="number" class="form-control" name="travel_height" step="0.01" value="{{ settings.travel_height }}" required>
                        <span class="input-group-text">in</span>
                    </div>
                    <div class="form-text">Height above work during rapid moves between operations</div>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Cut-Through Buffer</label>
                    <div class="input-group">
                        <input type="number" class="form-control" name="cut_through_buffer" step="0.005" min="0" max="0.1" value="{{ settings.cut_through_buffer or 0.01 }}" required>
                        <span class="input-group-text">in</span>
                    </div>
                    <div class="form-text">Extra depth below material for cut projects to ensure complete separation</div>
                </div>
            </div>

            <hr class="my-4">

            <h5>Spindle Settings</h5>
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">Spindle Warmup Time</label>
                    <div class="input-group">
                        <input type="number" class="form-control" name="spindle_warmup_seconds" min="0" value="{{ settings.spindle_warmup_seconds }}" required>
                        <span class="input-group-text">seconds</span>
                    </div>
                    <div class="form-text">Dwell time (G4) after spindle on to allow it to reach speed</div>
                </div>
            </div>

            <hr class="my-4">

            <h5>Lead-In Settings</h5>
            <p class="text-muted">Configure entry strategy for profile cuts to reduce tool stress. Each cut type can have its own lead-in method.</p>

            <div class="row g-3 mb-3">
                <div class="col-md-4">
                    <label class="form-label">Circle Lead-In</label>
                    <select class="form-select" name="circle_lead_in_type">
                        <option value="none" {% if settings.circle_lead_in_type == 'none' %}selected{% endif %}>None (vertical plunge)</option>
                        <option value="ramp" {% if settings.circle_lead_in_type == 'ramp' %}selected{% endif %}>Ramp (linear approach)</option>
                        <option value="helical" {% if settings.circle_lead_in_type == 'helical' or not settings.circle_lead_in_type %}selected{% endif %}>Helical (recommended)</option>
                    </select>
                    <div class="form-text">Spiral descent at center, then arc to profile</div>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Hexagon Lead-In</label>
                    <select class="form-select" name="hexagon_lead_in_type">
                        <option value="none" {% if settings.hexagon_lead_in_type == 'none' %}selected{% endif %}>None (vertical plunge)</option>
                        <option value="ramp" {% if settings.hexagon_lead_in_type == 'ramp' %}selected{% endif %}>Ramp (linear approach)</option>
                        <option value="helical" {% if settings.hexagon_lead_in_type == 'helical' or not settings.hexagon_lead_in_type %}selected{% endif %}>Helical (recommended)</option>
                    </select>
                    <div class="form-text">Spiral descent at center, then move to first vertex</div>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Line Lead-In</label>
                    <select class="form-select" name="line_lead_in_type">
                        <option value="none" {% if settings.line_lead_in_type == 'none' %}selected{% endif %}>None (vertical plunge)</option>
                        <option value="ramp" {% if settings.line_lead_in_type == 'ramp' or not settings.line_lead_in_type %}selected{% endif %}>Ramp (recommended)</option>
                    </select>
                    <div class="form-text">Linear ramp from lead-in point to profile start</div>
                </div>
            </div>

            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">Ramp Angle</label>
                    <div class="input-group">
                        <input type="number" class="form-control" name="ramp_angle" step="0.5" min="1" max="15" value="{{ settings.ramp_angle or 3.0 }}" required>
                        <span class="input-group-text">degrees</span>
                    </div>
                    <div class="form-text">Entry angle for ramp lead-in (2-5Â° recommended for aluminum)</div>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Helix Pitch</label>
                    <div class="input-group">
                        <input type="number" class="form-control" name="helix_pitch" step="0.01" min="0.01" max="0.25" value="{{ settings.helix_pitch or 0.04 }}" required>
                        <span class="input-group-text">in/rev</span>
                    </div>
                    <div class="form-text">Z descent per revolution during helical lead-in (0.02-0.10" typical)</div>
                </div>
            </div>

            <hr class="my-4">

            <h5>Feed Rate Safety</h5>
            <p class="text-muted">Reduce feed rate in high-stress situations to prevent tool breakage</p>

            <div class="row g-3 mb-3">
                <div class="col-md-6">
                    <label class="form-label">First Pass Feed Reduction</label>
                    <div class="input-group">
                        <input type="number" class="form-control" name="first_pass_feed_factor" step="0.05" min="0.3" max="1.0" value="{{ settings.first_pass_feed_factor or 0.7 }}" required>
                        <span class="input-group-text">factor</span>
                    </div>
                    <div class="form-text">Multiply feed rate by this factor on first pass (0.7 = 70% of normal feed)</div>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Max Stepdown Factor</label>
                    <div class="input-group">
                        <input type="number" class="form-control" name="max_stepdown_factor" step="0.05" min="0.25" max="1.0" value="{{ settings.max_stepdown_factor or 0.5 }}" required>
                        <span class="input-group-text">factor</span>
                    </div>
                    <div class="form-text">Warn if pass depth exceeds this factor of tool diameter (0.5 = 50%)</div>
                </div>
            </div>

            <hr class="my-4">

            <h5>Bounds Validation</h5>
            <p class="text-muted">Control how toolpath coordinates are validated against machine limits</p>

            <div class="row g-3 mb-3">
                <div class="col-md-6">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" name="allow_negative_coordinates" id="allow_negative_coordinates" {% if settings.allow_negative_coordinates %}checked{% endif %}>
                        <label class="form-check-label" for="allow_negative_coordinates">Allow Negative Coordinates</label>
                    </div>
                    <div class="form-text">Skip validation for toolpaths extending past X=0 or Y=0. Useful for exterior cuts on patterns starting at the origin.</div>
                </div>
            </div>

            <hr class="my-4">

            <h5>Corner Slowdown</h5>
            <p class="text-muted">Reduce feed rate at sharp corners to improve cut quality and reduce tool stress</p>

            <div class="row g-3">
                <div class="col-md-6">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" name="corner_slowdown_enabled" id="corner_slowdown_enabled" {% if settings.corner_slowdown_enabled or settings.corner_slowdown_enabled is none %}checked{% endif %}>
                        <label class="form-check-label" for="corner_slowdown_enabled">Enable Corner Slowdown</label>
                    </div>
                    <div class="form-text">Automatically reduce feed at sharp corners in line cuts</div>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Corner Feed Factor</label>
                    <div class="input-group">
                        <input type="number" class="form-control" name="corner_feed_factor" step="0.05" min="0.2" max="1.0" value="{{ settings.corner_feed_factor or 0.5 }}" required>
                        <span class="input-group-text">factor</span>
                    </div>
                    <div class="form-text">Base feed reduction at corners (0.5 = 50% of normal feed)</div>
                </div>
            </div>

            <hr class="my-4">

            <h5>Arc Slowdown</h5>
            <p class="text-muted">Reduce feed rate on arc moves (G02/G03) for improved cut quality</p>

            <div class="row g-3">
                <div class="col-md-6">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" name="arc_slowdown_enabled" id="arc_slowdown_enabled" {% if settings.arc_slowdown_enabled or settings.arc_slowdown_enabled is none %}checked{% endif %}>
                        <label class="form-check-label" for="arc_slowdown_enabled">Enable Arc Slowdown</label>
                    </div>
                    <div class="form-text">Automatically reduce feed on arc moves in line cuts</div>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Arc Feed Factor</label>
                    <div class="input-group">
                        <input type="number" class="form-control" name="arc_feed_factor" step="0.05" min="0.5" max="1.0" value="{{ settings.arc_feed_factor or 0.8 }}" required>
                        <span class="input-group-text">factor</span>
                    </div>
                    <div class="form-text">Feed reduction on arcs (0.8 = 80% of normal feed)</div>
                </div>
            </div>
        </div>
        <div class="card-footer">
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-check-lg"></i> Save Settings
            </button>
            <a href="{{ url_for('settings.index') }}" class="btn btn-outline-secondary">Cancel</a>
        </div>
    </div>
</form>
{% endblock %}
